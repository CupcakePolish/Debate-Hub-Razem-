<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Razem Debate Hub — transkrypty i branche</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --rzm-accent:#7b1c7d; --rzm-accent-2:#a0237f; --rzm-accent-3:#d23d94;
    --ink:#151515; --muted:#6a6a6a; --bg:#f6f6f8; --paper:#fff; --line:#e7e7ee;
    --radius:14px; --shadow:0 20px 60px rgba(0,0,0,.12); --shadow-sm:0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Arial}
  button,input,textarea{font:inherit;color:inherit}
  
  /* Header */
  header.appbar{position:sticky;top:0;z-index:100;background:linear-gradient(90deg,var(--rzm-accent),var(--rzm-accent-2));color:#fff;box-shadow:var(--shadow-sm)}
  .appbar-inner{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center;cursor:pointer}
  .logo{background:#fff;color:#5f0d62;font-weight:900;padding:6px 10px;border-radius:8px}
  .brand h1{margin:0;font-size:18px}
  .bar-actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid rgba(255,255,255,.7);background:#fff0;color:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.solid{background:#fff;color:#5b0c66;border-color:#fff}
  .btn.purple{background:var(--rzm-accent-3);border-color:#ffd6f0;color:#fff}

  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:14px}
  .grid{display:grid;gap:14px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)} @media (max-width:980px){.grid.cols-3{grid-template-columns:1fr}}
  .muted{color:var(--muted)} .row{display:flex;gap:10px;flex-wrap:wrap}

  /* HOME */
  #home .doc-card{padding:14px;border:1px solid var(--line);border-radius:12px;background:#fff}
  #home .doc-card:hover{border-color:#d8c3df;box-shadow:var(--shadow-sm)}

  /* DOC */
  #doc{display:none}
  .toolbar-holder{position:sticky;top:66px;z-index:90}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow-sm);padding:10px}
  .tbtn{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:700;color:#5b0c66}
  .tbtn.primary{background:linear-gradient(180deg,var(--rzm-accent-3),var(--rzm-accent-2));color:#fff;border-color:#dc8ad2}

  /* === anchor popover (menu branchy) === */
  .popover{
    position:absolute;
    display:none;
    z-index:95;
    background:#fff;
    border:1px solid var(--line);
    border-radius:10px;
    box-shadow:var(--shadow-sm);
    padding:6px;
    min-width:260px;
  }
  .popover .pop-item{ padding:8px 10px; border-radius:8px; cursor:pointer; }
  .popover .pop-item:hover{ background:#f6eaf4; }

  /* Canvas */
  .canvas{display:grid;grid-template-columns:1fr min(900px,92vw) 1fr}
  .page{grid-column:2;background:var(--paper);min-height:70vh;margin:14px 0;padding:96px 96px;box-shadow:var(--shadow);border-radius:6px}

  /* Meta box */
  .meta-box{grid-column:2;margin-top:12px;margin-bottom:8px}
  .meta-box .panel{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .meta-box .panel label{font-size:12px;color:var(--muted)}
  .input{width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;padding:9px 10px}

  .meta-view{display:flex;flex-direction:column;gap:6px}
  .meta-line{display:flex;gap:8px;align-items:center}
  .meta-line a{color:#5b0c66;text-decoration:underline}

  .branch-anchor{background:linear-gradient(0deg,rgba(160,35,127,.12),rgba(160,35,127,.12));border-bottom:2px solid var(--rzm-accent-2);border-radius:6px;padding:0 3px}
  .inline-tag{display:inline-flex;gap:6px;align-items:center;border:1px solid #e9d3ee;background:#faf2fb;color:#5c0d66;padding:1px 8px;border-radius:999px;font-size:12px;margin-left:6px;cursor:pointer}
  .inline-tag,[contenteditable=false]{-webkit-user-select:none;user-select:none}

  /* Drawer (branch) */
  .drawer{position:fixed;right:18px;bottom:18px;width:min(560px,96vw);max-height:84vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);display:none;z-index:80;resize:both}
  .drawer header{cursor:move;padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .drawer .content{padding:12px}
  .sep{height:1px;background:var(--line);margin:12px 0}

  /* Comments */
  .comments{display:flex;flex-direction:column;gap:8px}
  .comment{display:flex;gap:10px;align-items:flex-start;background:#fafafa;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
  .comment .avatar{flex-shrink:0;width:28px;height:28px;border-radius:50%;background:#efe3f2;color:#5b0c66;display:grid;place-items:center;font-weight:800}
  .comment .meta{font-size:12px;color:var(--muted)}
  .comment .del{margin-left:auto;border:1px solid #e7b7c3;background:#fdecef;color:#7f0f25;border-radius:8px;padding:2px 8px;cursor:pointer}

  /* Reactions */
  .reactions{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
  .chip.active{outline:2px solid #d68ad0}
  .badge{font-size:12px;background:#efecf2;border:1px solid #e1d6e7;padding:2px 6px;border-radius:8px;margin-left:6px}

  /* Modal: Przegląd */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:85}
  .modal .box{width:min(900px,95vw);max-height:80vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:12px}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}

  /* Highlighter animation */
  @keyframes flash {
    0%{box-shadow:0 0 0 0 rgba(210,61,148,.6)}
    100%{box-shadow:0 0 0 14px rgba(210,61,148,0)}
  }
  .flash{animation:flash 1.2s ease-out 0s 2}
</style>
</head>
<body>

<header class="appbar">
  <div class="appbar-inner">
    <div class="brand" id="brand-home"><div class="logo">razem</div><h1>Debate Hub</h1></div>
    <div class="bar-actions" id="global-actions">
      <label class="btn">Dodaj .docx <input id="home-docx" type="file" accept=".docx" hidden /></label>
      <button class="btn purple" id="home-new">Nowy pusty</button>
      <label class="btn">Import projektu <input id="home-import" type="file" accept="application/json" hidden /></label>
      <button class="btn" id="home-clear">Wyczyść wszystko</button>

      <!-- ADDED: shows current username once logged in -->
      <span id="user-badge" style="opacity:.8;margin-left:8px;"></span>
    </div>
    <div class="bar-actions" id="doc-actions" style="display:none">
      <button class="btn" id="back-home">Transkrypty</button>
      <button class="btn" id="open-overview">Przegląd branchy</button>
      <button class="btn purple" id="doc-export">Export projektu</button>
      <label class="btn">Import do dokumentu <input id="doc-import" type="file" accept="application/json" hidden /></label>
      <button class="btn" id="doc-delete">Usuń dokument</button>
    </div>
  </div>
</header>

<!-- HOME -->
<main id="home" class="wrap">
  <div class="panel">
    <h2 style="margin:6px 0 10px">Twoje transkrypty</h2>
    <div id="doc-list" class="grid cols-3"></div>
    <p id="empty-home" class="muted" style="font-style:italic;margin-top:8px">Brak dokumentów. Dodaj .docx lub utwórz pusty.</p>
  </div>

 
</main>

<!-- DOC -->
<main id="doc" class="wrap">
  <div class="toolbar-holder">
    <div class="toolbar">
      <button class="tbtn" data-cmd="bold">B</button>
      <button class="tbtn" data-cmd="italic">I</button>
      <button class="tbtn" data-cmd="underline">U</button>
      <button class="tbtn" id="font-dec">A−</button>
      <button class="tbtn" id="font-inc">A+</button>
      <button class="tbtn" data-cmd="insertUnorderedList">• Lista</button>
      <button class="tbtn" data-cmd="insertOrderedList">1. Lista</button>
      <button class="tbtn" id="clear-format">Wyczyść formatowanie</button>
      <button class="tbtn primary" id="add-branch">Dodaj branch (z zaznaczenia)</button>
      <span class="muted" style="margin-left:auto">Ctrl/Cmd+B/I/U • Ctrl+Z/Ctrl+Shift+Z</span>
    </div>
  </div>

  <!-- meta box -->
  <div class="meta-box">
    <!-- tryb edycji -->
    <div class="panel" id="meta-edit">
      <div>
        <label>Tytuł transkryptu</label>
        <input id="meta-title" class="input" placeholder="Nazwa debaty">
      </div>
      <div>
        <label>Link YouTube</label>
        <input id="meta-yt" class="input" placeholder="https://youtu.be/...">
      </div>
      <div style="grid-column:1/3">
        <label>Krótki opis</label>
        <input id="meta-desc" class="input" placeholder="O co chodzi w tej debacie?">
      </div>
      <div style="grid-column:1/3;display:flex;gap:8px">
        <button class="tbtn primary" id="meta-publish">Opublikuj metadane</button>
      </div>
    </div>
    <!-- tryb podglądu -->
    <div class="panel" id="meta-view" style="display:none">
      <div class="meta-view">
        <div class="meta-line"><strong id="v-title"></strong></div>
        <div class="meta-line">YT: <a id="v-yt" href="#" target="_blank" rel="noopener">—</a></div>
        <div id="v-desc" class="muted"></div>
      </div>
      <div style="margin-top:8px"><button class="tbtn" id="meta-edit-btn">Edytuj metadane</button></div>
    </div>
  </div>

  <div class="canvas" id="canvas">
    <article id="page" class="page" contenteditable="true" spellcheck="false"></article>
  </div>
</main>

<!-- Drawer (branch) -->
<section class="drawer" id="drawer" role="dialog" aria-modal="true">
  <header id="drawer-head">
    <strong id="drawer-title">Branch</strong>
    <button class="tbtn" id="drawer-close">Zamknij</button>
  </header>
  <div class="content">
    <div id="b-editable">
      <label class="muted">Tytuł brancha</label>
      <input id="b-title" class="input" placeholder="Krótki tytuł" />
      <label class="muted" style="margin-top:8px">Treść</label>
      <textarea id="b-body" rows="5" class="input" placeholder="Teza, pytanie, propozycja poprawy…"></textarea>
      <div class="sep"></div>
      <div class="row">
        <button id="b-post" class="tbtn primary">Opublikuj brancha</button>
        <span id="b-status" class="muted"></span>
      </div>
    </div>

    <div id="b-locked" style="display:none">
      <div style="background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;margin:6px 0">
        <div id="b-view-title" style="font-weight:800;margin-bottom:6px"></div>
        <div id="b-view-body" style="white-space:pre-wrap"></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="b-edit" class="tbtn">Edytuj mój wpis</button>
      </div>
    </div>

    <div id="post-section" style="display:none">
      <div class="sep"></div>
      <div class="reactions" id="react-bar"></div>

      <div class="sep"></div>
      <label class="muted">Dodaj odpowiedź</label>
      <div class="row" style="gap:8px">
        <input id="reply-text" class="input" placeholder="Napisz i Enter" />
        <button id="reply-btn" class="tbtn">Dodaj</button>
      </div>
      <div id="comments" class="comments" style="margin-top:10px"></div>
    </div>

    <div class="sep"></div>
    <button id="b-delete" class="tbtn" style="color:#8a0d28;border-color:#e5b3be">Usuń brancha</button>
  </div>
</section>

<!-- Modal: Przegląd -->
<section id="overview" class="modal" aria-modal="true">
  <div class="box">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">Przegląd branchy</h3>
      <button id="overview-close" class="tbtn">Zamknij</button>
    </div>
    <div class="row" style="margin:8px 0 12px">
      <span class="pill" data-sort="top">Top reakcje</span>
      <span class="pill" data-sort="comments">Najwięcej komentarzy</span>
      <span class="pill" data-sort="new">Najnowsze</span>
    </div>
    <div id="overview-list"></div>
  </div>
</section>

<!-- Popover anchor menu -->
<div id="anchor-pop" class="popover"></div>

<!-- Mammoth (docx) -->
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s), uid=()=>Math.random().toString(36).slice(2,9);
const DEVKEY="razem-device-id"; let deviceId=localStorage.getItem(DEVKEY); if(!deviceId){deviceId="u_"+uid(); localStorage.setItem(DEVKEY,deviceId);}
function esc(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) )}

const HUB_KEY="razem-hub-v7"; let hub={docs:{},lastOpenId:null};
function load(){const raw=localStorage.getItem(HUB_KEY); if(raw){try{hub=JSON.parse(raw)}catch{}}}
function save(){localStorage.setItem(HUB_KEY,JSON.stringify(hub)); if($("#home").style.display==="block") renderHome();}

/* ===== Undo/Redo ===== */
const historyStack=[], redoStack=[];
function snapshot(){ if(!curId) return; const d=structuredClone(hub.docs[curId]); historyStack.push(d); if(historyStack.length>60) historyStack.shift(); redoStack.length=0; }
function undo(){ const prev=historyStack.pop(); if(!prev) return; redoStack.push(structuredClone(hub.docs[curId])); hub.docs[curId]=prev; save(); openDoc(curId); }
function redo(){ const next=redoStack.pop(); if(!next) return; historyStack.push(structClone(hub.docs[curId])); hub.docs[curId]=next; save(); openDoc(curId); }
function structClone(o){return structuredClone?structuredClone(o):JSON.parse(JSON.stringify(o));}
document.addEventListener("keydown",e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==="z"){ e.preventDefault(); e.shiftKey?redo():undo(); }});

/* ===== Docs ===== */
function createDoc({title="Nowy dokument",html=""}={}){const id="d_"+uid(); hub.docs[id]={id,title,desc:"",yt:"",metaPublished:false,html,branches:{},anchors:{},created:new Date().toISOString(),updated:new Date().toISOString()}; save(); return id}
function deleteDoc(id){delete hub.docs[id]; if(hub.lastOpenId===id) hub.lastOpenId=null; save()}

/* ===== Home ===== */
function renderHome(){
  $("#home").style.display="block"; $("#doc").style.display="none";
  $("#global-actions").style.display="flex"; $("#doc-actions").style.display="none";
  const list=$("#doc-list"); list.innerHTML="";
  const docs=Object.values(hub.docs).sort((a,b)=>a.updated<b.updated?1:-1);
  $("#empty-home").style.display=docs.length?"none":"block";
  docs.forEach(d=>{
    const el=document.createElement("div"); el.className="doc-card";
    const desc = d.desc?.trim() ? esc(d.desc.trim()) : "<i class='muted'>(brak opisu)</i>";
    el.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
        <strong>${esc(d.title)}</strong><span class="muted" style="margin-left:auto">${new Date(d.updated).toLocaleString()}</span>
      </div>
      <div class="muted" style="margin-top:6px">${desc}</div>
      <div class="row" style="margin-top:8px">
        <button class="tbtn" data-open="${d.id}">Otwórz</button>
        <button class="tbtn" data-export="${d.id}">Export</button>
        <button class="tbtn" data-del="${d.id}" style="color:#8a0d28;border-color:#e5b3be">Usuń</button>
      </div>`;
    list.appendChild(el);
  });
  list.querySelectorAll("[data-open]").forEach(b=>b.onclick=()=>openDoc(b.dataset.open));
  list.querySelectorAll("[data-export]").forEach(b=>b.onclick=()=>exportDoc(b.dataset.export));
  list.querySelectorAll("[data-del]").forEach(b=>b.onclick=()=>{if(confirm("Usunąć dokument?")){deleteDoc(b.dataset.del); renderHome();}})
}
$("#brand-home").onclick=()=>renderHome();

/* ===== Doc ===== */
let curId=null, curBranchId=null;
function openDoc(id){
  curId=id; hub.lastOpenId=id; save();
  $("#home").style.display="none"; $("#doc").style.display="block";
  $("#global-actions").style.display="none"; $("#doc-actions").style.display="flex";
  const d=hub.docs[id];
  $("#page").innerHTML=d.html||"<p><b>Wklej tutaj transkrypt.</b></p>";
  setMetaMode(d.metaPublished);
  $("#meta-title").value=d.title||""; $("#meta-yt").value=d.yt||""; $("#meta-desc").value=d.desc||"";
  $("#v-title").textContent=d.title||""; $("#v-yt").textContent=d.yt||"—"; $("#v-yt").href=d.yt||"#"; $("#v-desc").textContent=d.desc||"";
  attachInline();
}

/* meta view/edit toggle */
function setMetaMode(published){
  $("#meta-edit").style.display= published? "none":"grid";
  $("#meta-view").style.display= published? "block":"none";
}
$("#meta-publish").onclick=()=>{const d=hub.docs[curId]; snapshot();
  d.title=$("#meta-title").value.trim()||"Bez tytułu";
  d.yt=$("#meta-yt").value.trim(); d.desc=$("#meta-desc").value.trim();
  d.metaPublished=true; d.updated=new Date().toISOString(); save();
  $("#v-title").textContent=d.title; $("#v-yt").textContent=d.yt||"—"; $("#v-yt").href=d.yt||"#"; $("#v-desc").textContent=d.desc||"";
  setMetaMode(true);
};
$("#meta-edit-btn").onclick=()=>{const d=hub.docs[curId]; setMetaMode(false); $("#meta-title").value=d.title; $("#meta-yt").value=d.yt; $("#meta-desc").value=d.desc;};
["meta-title","meta-yt","meta-desc"].forEach(id=>{
  $("#"+id).addEventListener("input",()=>{const d=hub.docs[curId]; if(!d) return; snapshot(); d.title=$("#meta-title").value; d.yt=$("#meta-yt").value; d.desc=$("#meta-desc").value; d.updated=new Date().toISOString(); save();});
});

$("#page").addEventListener("input",()=>{const d=hub.docs[curId]; d.html=$("#page").innerHTML; d.updated=new Date().toISOString(); save();});
$("#page").addEventListener("keydown",()=>{snapshot();},{capture:true});

/* zabezpieczenie tagów */
$("#page").addEventListener("beforeinput",(e)=>{
  const sel=window.getSelection(); if(!sel.rangeCount) return;
  const node=(sel.anchorNode?.nodeType===1? sel.anchorNode: sel.anchorNode?.parentElement);
  if(e.inputType.startsWith("delete") || e.inputType==="insertText"){
    if(node && (node.closest(".inline-tag") || node.closest("[contenteditable='false']"))) e.preventDefault();
  }
});

/* toolbar actions */
document.querySelectorAll(".tbtn[data-cmd]").forEach(b=>b.onclick=()=>{snapshot(); document.execCommand(b.dataset.cmd,false,null); const d=hub.docs[curId]; d.html=$("#page").innerHTML; save()});
function fontDelta(n){const sel=window.getSelection(); if(!sel.rangeCount||sel.isCollapsed) return; snapshot(); const r=sel.getRangeAt(0); const s=document.createElement("span"); s.style.fontSize=`calc(1em + ${n>0?'.1':'-.1'}em)`; s.appendChild(r.extractContents()); r.insertNode(s); const d=hub.docs[curId]; d.html=$("#page").innerHTML; save()}
$("#font-inc").onclick=()=>fontDelta(1); $("#font-dec").onclick=()=>fontDelta(-1);
$("#clear-format").onclick=()=>{snapshot(); document.execCommand("removeFormat",false,null); const d=hub.docs[curId]; d.html=$("#page").innerHTML; save()};

/* add branch */
function addBranchFromSelection(){
  const sel=window.getSelection(); if(!sel.rangeCount||sel.isCollapsed){alert("Zaznacz tekst."); return;}
  snapshot();
  const r=sel.getRangeAt(0); const anchorId="a_"+uid(); const wrap=document.createElement("span");
  wrap.className="branch-anchor"; wrap.id=anchorId; wrap.appendChild(r.cloneContents()); r.deleteContents(); r.insertNode(wrap); sel.removeAllRanges();
  const bid="b_"+uid(); spawnInlineTag(anchorId);
  const q=wrap.textContent.trim().slice(0,180); const d=hub.docs[curId];
  if(!d.anchors[anchorId]) d.anchors[anchorId]=[]; d.anchors[anchorId].push(bid);
  d.branches[bid]={id:bid,anchorId,quoteText:q,title:"",body:"",comments:[],reactions:{plus:[],wiki:[]},owner:deviceId,posted:false,created:new Date().toISOString(),updated:new Date().toISOString()};
  d.html=$("#page").innerHTML; d.updated=new Date().toISOString(); save(); openBranch(bid,true);
}
$("#add-branch").onclick=addBranchFromSelection;

/* inline tag (branch ×N) */
function spawnInlineTag(anchorId){
  const anchor=document.getElementById(anchorId); if(!anchor) return;
  const next=anchor.nextElementSibling; if(next && next.classList.contains("inline-tag")) next.remove();
  const d=hub.docs[curId]; const count=(d.anchors[anchorId]||[]).length;
  const tag=document.createElement("span");
  tag.className="inline-tag"; tag.textContent=count?`branch ×${count}`:"branch"; tag.dataset.anchor=anchorId;
  tag.setAttribute("contenteditable","false");
  tag.addEventListener("click",(e)=>openAnchorMenu(e.currentTarget));
  anchor.after(tag);
}
function attachInline(){ const d=hub.docs[curId]; Object.keys(d.anchors).forEach(aid=>{ if(document.getElementById(aid)) spawnInlineTag(aid); }); }
const pop=$("#anchor-pop");
function openAnchorMenu(el){
  const rect=el.getBoundingClientRect(); const aid=el.dataset.anchor; const d=hub.docs[curId]; const arr=d.anchors[aid]||[];
  pop.innerHTML="";
  const add=document.createElement("div"); add.className="pop-item"; add.textContent="Dodaj nowy branch"; add.onclick=()=>{pop.style.display="none"; const a=document.getElementById(aid); if(!a) return; const range=document.createRange(); range.selectNodeContents(a); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range); addBranchFromSelection(); };
  pop.appendChild(add);
  arr.forEach(bid=>{const b=d.branches[bid]; const it=document.createElement("div"); it.className="pop-item"; it.textContent=(b.title||b.quoteText||"branch").slice(0,80); it.onclick=()=>{pop.style.display="none"; openBranch(bid);} ; pop.appendChild(it);});
  pop.style.left=(rect.left+window.scrollX)+"px"; pop.style.top=(rect.bottom+window.scrollY+6)+"px"; pop.style.display="block";
}
document.addEventListener("click",(e)=>{ if(pop.style.display==="block" && !pop.contains(e.target) && !e.target.classList.contains("inline-tag")) pop.style.display="none"; });

/* drawer */
function openBranch(bid,newly=false){
  curBranchId=bid; const b=hub.docs[curId].branches[bid];
  if(b.posted){
    $("#b-editable").style.display="none";
    $("#b-locked").style.display="block";
    $("#post-section").style.display="block";
    $("#drawer-title").textContent=b.title||"Branch";
    $("#b-view-title").textContent=b.title||"(bez tytułu)";
    $("#b-view-body").textContent=b.body||"";
  }else{
    $("#b-editable").style.display="block";
    $("#b-locked").style.display="none";
    $("#post-section").style.display="none";
    $("#drawer-title").textContent="Branch";
    $("#b-title").value=b.title||"";
    $("#b-body").value=b.body||"";
    $("#b-status").textContent="Roboczy — opublikuj, aby odblokować odpowiedzi i reakcje.";
  }
  renderReactions(b); renderComments(b);
  $("#drawer").style.display="block";
  if(newly && !b.posted) $("#b-title").focus();
}
function closeDrawer(){ $("#drawer").style.display="none"; curBranchId=null }
$("#drawer-close").onclick=closeDrawer;

/* drag drawer */
(()=>{const el=$("#drawer"), head=$("#drawer-head"); let sx,sy,ox,oy,drag=false;
  head.addEventListener("mousedown",(e)=>{drag=true; sx=e.clientX; sy=e.clientY; const r=el.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect="none";});
  window.addEventListener("mousemove",(e)=>{if(!drag) return; el.style.left=(ox+e.clientX-sx)+"px"; el.style.top=(oy+e.clientY-sy)+"px"; el.style.right="auto"; el.style.bottom="auto";});
  window.addEventListener("mouseup",()=>{drag=false; document.body.style.userSelect="";});
})();

/* publish/edit/delete */
$("#b-post").onclick=()=>{const b=branch(); if(!b) return; const t=$("#b-title").value.trim(), body=$("#b-body").value.trim(); if(!t||!body){alert("Podaj tytuł i treść."); return;} snapshot(); b.title=t; b.body=body; b.posted=true; b.updated=new Date().toISOString(); save(); openBranch(b.id);};
$("#b-edit").onclick=()=>{const b=branch(); if(!b) return; if(b.owner!==deviceId){alert("Tylko autor może edytować wpis."); return;} $("#b-editable").style.display="block"; $("#b-locked").style.display="none"; $("#post-section").style.display="none"; $("#b-title").value=b.title||""; $("#b-body").value=b.body||""; $("#b-title").focus();};
$("#b-delete").onclick=()=>{const d=hub.docs[curId]; const b=d.branches[curBranchId]; if(!b) return; if(!confirm("Usunąć brancha?")) return; snapshot();
  const tag=document.querySelector(`.inline-tag[data-anchor='${b.anchorId}']`); const anchor=document.getElementById(b.anchorId);
  d.anchors[b.anchorId]=(d.anchors[b.anchorId]||[]).filter(x=>x!==b.id);
  if(d.anchors[b.anchorId].length===0){ if(anchor){const p=anchor.parentNode; while(anchor.firstChild) p.insertBefore(anchor.firstChild,anchor); anchor.remove(); } if(tag) tag.remove(); delete d.anchors[b.anchorId]; }
  else{ if(tag) tag.textContent=`branch ×${d.anchors[b.anchorId].length}`; }
  delete d.branches[b.id]; d.html=$("#page").innerHTML; d.updated=new Date().toISOString(); save(); closeDrawer();
};
function branch(){return hub.docs[curId].branches[curBranchId]}

/* reactions */
function renderReactions(b){
  const bar=$("#react-bar"); bar.innerHTML="";
  const plusActive=(b.reactions?.plus||[]).includes(deviceId);
  const wikiActive=(b.reactions?.wiki||[]).includes(deviceId);

  const plus=document.createElement("button");
  plus.className="chip"+(plusActive?" active":"");
  plus.innerHTML=`+1 <span class="badge">${(b.reactions.plus||[]).length}</span>`;
  plus.onclick=()=>{snapshot(); toggleOne(b,"plus");};

  const wiki=document.createElement("button");
  wiki.className="chip"+(wikiActive?" active":"");
  wiki.innerHTML=`Wiki <span class="badge">${(b.reactions.wiki||[]).length}</span>`;
  wiki.onclick=()=>{snapshot(); toggleOne(b,"wiki");};

  bar.appendChild(plus); bar.appendChild(wiki);
}
function toggleOne(b,key){
  if(!b.posted) return; b.reactions=b.reactions||{plus:[],wiki:[]}; if(!Array.isArray(b.reactions[key])) b.reactions[key]=[];
  const arr=b.reactions[key]; const i=arr.indexOf(deviceId); if(i>-1) arr.splice(i,1); else arr.push(deviceId);
  b.updated=new Date().toISOString(); save(); renderReactions(b);
}

/* comments */
$("#reply-btn").onclick=addReply; $("#reply-text").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault(); addReply();}});
function addReply(){const b=branch(); if(!b||!b.posted) return; const t=$("#reply-text").value.trim(); if(!t) return; snapshot(); b.comments.push({id:"c_"+uid(),userId:deviceId,text:t,ts:new Date().toISOString()}); $("#reply-text").value=""; b.updated=new Date().toISOString(); save(); renderComments(b);}
function deleteComment(cid){const b=branch(); if(!b) return; snapshot(); b.comments=b.comments.filter(c=>!(c.id===cid && c.userId===deviceId)); b.updated=new Date().toISOString(); save(); renderComments(b);}
function renderComments(b){
  const box=$("#comments"); box.innerHTML="";
  if(!b.comments.length){ box.innerHTML=`<div class="muted"><i>Brak odpowiedzi.</i></div>`; return }
  b.comments.forEach(c=>{
    const el=document.createElement("div"); el.className="comment";
    const initial=(c.userId?.slice(-1)||"U").toUpperCase();
    el.innerHTML=`<div class="avatar">${initial}</div>
      <div style="min-width:0">
        <div style="word-wrap:break-word; white-space:pre-wrap">${esc(c.text)}</div>
        <div class="meta">${new Date(c.ts).toLocaleString()}</div>
      </div>
      ${c.userId===deviceId?'<button class="del" data-cid="'+c.id+'">Usuń</button>':''}`;
    box.appendChild(el);
  });
  box.querySelectorAll("[data-cid]").forEach(b=>b.onclick=()=>deleteComment(b.dataset.cid));
}

/* Overview modal */
$("#open-overview").onclick=()=>openOverview("top");
$("#overview-close").onclick=()=>$("#overview").style.display="none";
document.querySelectorAll("#overview .pill").forEach(p=>p.onclick=()=>openOverview(p.dataset.sort));
function openOverview(mode){
  const d=hub.docs[curId]; const list=$("#overview-list"); const modal=$("#overview");
  let arr=Object.values(d.branches||{}).filter(b=>b.posted);
  const score=b=> (b.reactions.plus?.length||0)+(b.reactions.wiki?.length||0);
  if(mode==="top") arr.sort((a,b)=>score(b)-score(a));
  else if(mode==="comments") arr.sort((a,b)=>b.comments.length-a.comments.length);
  else arr.sort((a,b)=>new Date(b.created)-new Date(a.created));
  list.innerHTML="";
  if(!arr.length){ list.innerHTML=`<p class="muted"><i>Brak opublikowanych branchy.</i></p>`; }
  arr.forEach(b=>{
    const el=document.createElement("div"); el.className="panel"; el.style.marginTop="8px";
    el.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
        <strong>${esc(b.title||"(bez tytułu)")}</strong>
        <span class="muted" style="margin-left:auto">${new Date(b.created).toLocaleString()}</span>
      </div>
      <div class="muted" style="margin-top:4px">„${esc(b.quoteText||"")}”</div>
      <div class="row" style="margin-top:6px">
        <button class="tbtn" data-open="${b.id}">Otwórz</button>
        <button class="tbtn" data-jump="${b.anchorId}">Pokaż w tekście</button>
        <span class="muted" style="margin-left:auto">💬 ${b.comments.length} • ✨ ${score(b)}</span>
      </div>`;
    list.appendChild(el);
  });
  list.querySelectorAll("[data-open]").forEach(btn=>btn.onclick=()=>{modal.style.display="none"; openBranch(btn.dataset.open);});
  list.querySelectorAll("[data-jump]").forEach(btn=>btn.onclick=()=>{modal.style.display="none"; scrollAndHighlight(btn.dataset.jump);});
  modal.style.display="flex";
}

/* Scroll & highlight */
function scrollAndHighlight(anchorId){
  const el=document.getElementById(anchorId);
  if(!el){alert("Nie znaleziono fragmentu (może został usunięty)."); return;}
  el.scrollIntoView({block:"center",behavior:"smooth"});
  el.classList.add("flash");
  setTimeout(()=>el.classList.remove("flash"),2400);
}

/* header buttons */
$("#back-home").onclick=()=>renderHome();
$("#doc-delete").onclick=()=>{if(confirm("Na pewno usunąć ten dokument?")){deleteDoc(curId); renderHome();}}
function exportDoc(id){const data=hub.docs[id]; const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=(data.title||"razem-debate")+".json"; a.click();}
$("#doc-export").onclick=()=>exportDoc(curId);
$("#doc-import").addEventListener("change",(e)=>{const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{try{const obj=JSON.parse(r.result); if(obj.id){hub.docs[obj.id]=obj; save(); openDoc(obj.id);} else alert("To nie jest plik dokumentu."); }catch{alert("Niepoprawny JSON")}}; r.readAsText(f);});

/* Home actions */
$("#home-new").onclick=()=>{const id=createDoc({title:"Nowy dokument",html:"<p><b>Wklej tutaj transkrypt.</b></p>"}); openDoc(id);};
$("#home-import").addEventListener("change",(e)=>{const f=e.target.files?.[0]; if(!f)return; const r=new FileReader(); r.onload=()=>{try{const obj=JSON.parse(r.result); if(obj.id){hub.docs[obj.id]=obj; save(); renderHome();} else alert("To nie jest plik dokumentu."); }catch{alert("Niepoprawny JSON")}}; r.readAsText(f);});
$("#home-clear").onclick=()=>{if(confirm("Usunąć wszystkie dane lokalne?")){localStorage.removeItem(HUB_KEY); location.reload();}};
$("#home-docx").addEventListener("change",async(e)=>{const file=e.target.files?.[0]; if(!file)return; try{const ab=await file.arrayBuffer(); const res=await window.mammoth.convertToHtml({arrayBuffer:ab}); const title=file.name.replace(/\.docx$/i,""); const id=createDoc({title,html:res.value}); openDoc(id);}catch(err){alert("Import .docx nie powiódł się — sprawdź konsolę."); console.error(err);}});

/* Init */
window.addEventListener("load",()=>{load(); if(Object.keys(hub.docs).length===0){renderHome(); return;} if(hub.lastOpenId && hub.docs[hub.lastOpenId]) openDoc(hub.lastOpenId); else renderHome();});
</script>

<!-- ADDED: show @username in header -->
<script>
(async () => {
  try {
    const r = await fetch('/api/me');
    if (r.ok) {
      const me = await r.json();
      if (me.username) {
        const el = document.getElementById('user-badge');
        if (el) el.textContent = '@' + me.username;
      }
    }
  } catch (e) {
    console.warn('me failed', e);
  }
})();
</script>


</body>
</html>

