<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Razem Debate Hub</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --accent:#7b1c7d; --accent2:#a0237f; --accent3:#d23d94;
    --ink:#151515; --muted:#6a6a6a; --bg:#f6f6f8; --paper:#fff; --line:#e7e7ee;
    --radius:14px; --shadow:0 20px 60px rgba(0,0,0,.12); --shadow-sm:0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Arial}

  header.appbar{position:sticky;top:0;z-index:100;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;box-shadow:var(--shadow-sm)}
  .appbar-inner{max-width:1200px;margin:0 auto;padding:10px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:10px;align-items:center;cursor:pointer}
  .logo{background:#fff;color:#5f0d62;font-weight:900;padding:6px 10px;border-radius:8px}
  .brand h1{margin:0;font-size:18px}
  .bar-actions{display:flex;gap:8px;flex-wrap:wrap}
  .btn{border:1px solid rgba(255,255,255,.7);background:#fff0;color:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.purple{background:var(--accent3);border-color:#ffd6f0;color:#fff}
  .btn.ghost{background:#fff;border-color:#fff;color:#5b0c66}
  .badge{opacity:.9}

  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .panel{background:#fff;border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow-sm);padding:14px}
  .grid{display:grid;gap:14px}
  .grid.cols-3{grid-template-columns:repeat(3,1fr)} @media (max-width:980px){.grid.cols-3{grid-template-columns:1fr}}
  .muted{color:var(--muted)} .row{display:flex;gap:10px;flex-wrap:wrap}

  #home .card{padding:14px;border:1px solid var(--line);border-radius:12px;background:#fff}
  #home .card:hover{border-color:#d8c3df;box-shadow:var(--shadow-sm)}

  #doc{display:none}
  .toolbar-holder{position:sticky;top:66px;z-index:90}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow-sm);padding:10px}
  .tbtn{background:#fff;border:1px solid var(--line);border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:700;color:#5b0c66}
  .tbtn.primary{background:linear-gradient(180deg,var(--accent3),var(--accent2));color:#fff;border-color:#dc8ad2}

  .canvas{display:grid;grid-template-columns:1fr min(900px,92vw) 1fr}
  .page{grid-column:2;background:var(--paper);min-height:70vh;margin:14px 0;padding:96px 96px;box-shadow:var(--shadow);border-radius:6px}

  .meta-box{grid-column:2;margin-top:12px;margin-bottom:8px}
  .meta-box .panel{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .meta-box .panel label{font-size:12px;color:var(--muted)}
  .input{width:100%;background:#fff;border:1px solid var(--line);border-radius:10px;padding:9px 10px}

  .meta-view{display:flex;flex-direction:column;gap:6px}
  .meta-line{display:flex;gap:8px;align-items:center}
  .meta-line a{color:#5b0c66;text-decoration:underline}

  .branch-anchor{background:linear-gradient(0deg,rgba(160,35,127,.12),rgba(160,35,127,.12));border-bottom:2px solid var(--accent2);border-radius:6px;padding:0 3px}
  .inline-tag{display:inline-flex;gap:6px;align-items:center;border:1px solid #e9d3ee;background:#faf2fb;color:#5c0d66;padding:1px 8px;border-radius:999px;font-size:12px;margin-left:6px;cursor:pointer;pointer-events:auto}
  .inline-tag,[contenteditable=false]{-webkit-user-select:none;user-select:none}

  .drawer{position:fixed;right:18px;bottom:18px;width:min(560px,96vw);max-height:84vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);display:none;z-index:80;resize:both}
  .drawer header{cursor:move;padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between}
  .drawer .content{padding:12px}
  .sep{height:1px;background:var(--line);margin:12px 0}

  .comments{display:flex;flex-direction:column;gap:8px}
  .comment{display:flex;gap:10px;align-items:flex-start;background:#fafafa;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
  .comment .meta{font-size:12px;color:var(--muted)}
  .comment .del{margin-left:auto;border:1px solid #e7b7c3;background:#fdecef;color:#7f0f25;border-radius:8px;padding:2px 8px;cursor:pointer}

  .reactions{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 10px;cursor:pointer}
  .chip.active{outline:2px solid #d68ad0}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:center;justify-content:center;z-index:85}
  .modal .box{width:min(900px,95vw);max-height:80vh;overflow:auto;background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:12px}
  .pill{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}

  @keyframes flash {0%{box-shadow:0 0 0 0 rgba(210,61,148,.6)}100%{box-shadow:0 0 0 14px rgba(210,61,148,0)}}
  .flash{animation:flash 1.2s ease-out 0s 2}

  /* pełnoekranowy wybór username */
  #username-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:120}
  #username-card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:18px;width:min(520px,95vw)}

  /* prosta “popover” dla listy branchy */
  .popover{
    position:absolute; display:none; z-index:95;
    background:#fff; border:1px solid var(--line); border-radius:10px; box-shadow:var(--shadow-sm);
    padding:6px; min-width:220px;
  }
  .pop-item{padding:8px 10px; border-radius:8px; cursor:pointer}
  .pop-item:hover{background:#f6f2f7}
</style>
</head>
<body>

<header class="appbar">
  <div class="appbar-inner">
    <div class="brand" id="brand-home"><div class="logo">razem</div><h1>Debate Hub</h1></div>
    <div class="bar-actions" id="global-actions">
      <label class="btn">Dodaj .docx <input id="home-docx" type="file" accept=".docx" hidden /></label>
      <button class="btn purple" id="home-new">Nowy pusty</button>
      <span class="badge" id="user-badge"></span>
    </div>
    <div class="bar-actions" id="doc-actions" style="display:none">
      <button class="btn" id="back-home">Transkrypty</button>
      <button class="btn" id="open-overview">Przegląd branchy</button>
      <button class="btn purple" id="doc-export">Export projektu</button>
      <button class="btn" id="doc-delete" title="Usuń dokument (tylko autor)">Usuń dokument</button>
      <span class="badge" id="user-badge-doc"></span>
    </div>
  </div>
</header>

<main id="home" class="wrap">
  <div class="panel">
    <h2 style="margin:6px 0 10px">Twoje transkrypty</h2>
    <div id="doc-list" class="grid cols-3"></div>
    <p id="empty-home" class="muted" style="font-style:italic;margin-top:8px">Brak dokumentów. Dodaj .docx lub utwórz pusty.</p>
  </div>
</main>

<main id="doc" class="wrap">
  <div class="toolbar-holder">
    <div class="toolbar">
      <button class="tbtn" data-cmd="bold">B</button>
      <button class="tbtn" data-cmd="italic">I</button>
      <button class="tbtn" data-cmd="underline">U</button>
      <button class="tbtn" id="font-dec">A−</button>
      <button class="tbtn" id="font-inc">A+</button>
      <button class="tbtn" data-cmd="insertUnorderedList">• Lista</button>
      <button class="tbtn" data-cmd="insertOrderedList">1. Lista</button>
      <button class="tbtn" id="clear-format">Wyczyść formatowanie</button>
      <button class="tbtn primary" id="add-branch">Dodaj branch (z zaznaczenia)</button>
      <span class="muted" style="margin-left:auto">Ctrl/Cmd+B/I/U • Ctrl+Z/Ctrl+Shift+Z</span>
    </div>
  </div>

  <div class="meta-box">
    <div class="panel" id="meta-edit">
      <div><label>Tytuł transkryptu</label><input id="meta-title" class="input" placeholder="Nazwa debaty"></div>
      <div><label>Link YouTube</label><input id="meta-yt" class="input" placeholder="https://youtu.be/..."></div>
      <div style="grid-column:1/3"><label>Krótki opis</label><input id="meta-desc" class="input" placeholder="O co chodzi w tej debacie?"></div>
      <div style="grid-column:1/3;display:flex;gap:8px"><button class="tbtn primary" id="meta-publish">Opublikuj metadane</button></div>
    </div>
    <div class="panel" id="meta-view" style="display:none">
      <div class="meta-view">
        <div class="meta-line"><strong id="v-title"></strong></div>
        <div class="meta-line">YT: <a id="v-yt" href="#" target="_blank" rel="noopener">—</a></div>
        <div id="v-desc" class="muted"></div>
      </div>
      <div style="margin-top:8px"><button class="tbtn" id="meta-edit-btn">Edytuj metadane</button></div>
    </div>
  </div>

  <div class="canvas" id="canvas">
    <article id="page" class="page" contenteditable="true" spellcheck="false"></article>
  </div>
</main>

<section class="drawer" id="drawer" role="dialog" aria-modal="true">
  <header id="drawer-head"><strong id="drawer-title">Branch</strong><button class="tbtn" id="drawer-close">Zamknij</button></header>
  <div class="content">
    <div id="b-editable">
      <label class="muted">Tytuł brancha</label>
      <input id="b-title" class="input" placeholder="Krótki tytuł" />
      <label class="muted" style="margin-top:8px">Treść</label>
      <textarea id="b-body" rows="5" class="input" placeholder="Teza, pytanie, propozycja poprawy…"></textarea>
      <div class="sep"></div>
      <div class="row"><button id="b-post" class="tbtn primary">Opublikuj brancha</button><span id="b-status" class="muted"></span></div>
    </div>

    <div id="b-locked" style="display:none">
      <div style="background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;margin:6px 0">
        <div id="b-view-title" style="font-weight:800;margin-bottom:6px"></div>
        <div id="b-view-body" style="white-space:pre-wrap"></div>
      </div>
      <div class="row" style="margin-top:8px"><button id="b-edit" class="tbtn">Edytuj mój wpis</button></div>

      <div class="sep"></div>
      <div class="muted" id="b-meta" style="font-size:12px"></div>
    </div>

    <div class="sep"></div>
    <div id="post-section" style="display:none">
      <div class="reactions" id="react-bar"></div>
      <div class="sep"></div>
      <label class="muted">Dodaj odpowiedź</label>
      <div class="row" style="gap:8px"><input id="reply-text" class="input" placeholder="Napisz i Enter" /><button id="reply-btn" class="tbtn">Dodaj</button></div>
      <div id="comments" class="comments" style="margin-top:10px"></div>
    </div>

    <div class="sep"></div>
    <button id="b-delete" class="tbtn" style="color:#8a0d28;border-color:#e5b3be">Usuń brancha</button>
  </div>
</section>

<section id="overview" class="modal" aria-modal="true">
  <div class="box">
    <div class="row" style="justify-content:space-between;align-items:center"><h3 style="margin:0">Przegląd branchy</h3><button id="overview-close" class="tbtn">Zamknij</button></div>
    <div class="row" style="margin:8px 0 12px"><span class="pill" data-sort="top">Top reakcje</span><span class="pill" data-sort="comments">Najwięcej komentarzy</span><span class="pill" data-sort="new">Najnowsze</span></div>
    <div id="overview-list"></div>
  </div>
</section>

<div id="anchor-pop" class="popover"></div>

<!-- Username overlay -->
<div id="username-overlay">
  <div id="username-card">
    <h3 style="margin:0 0 8px">Wybierz swój username</h3>
    <p class="muted" style="margin:0 0 10px">To będzie Twój podpis w Hubie. Dozwolone: a–z, 0–9 i _ , długość 3–20.</p>
    <div class="row" style="gap:8px">
      <input id="username-input" class="input" placeholder="np. kasia_nowak" style="flex:1">
      <button id="username-save" class="tbtn primary">Zapisz</button>
    </div>
    <div id="username-err" class="muted" style="color:#8a0d28;margin-top:8px"></div>
  </div>
</div>

<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<script>
/* ====== MINI-UTILS ====== */
const $=s=>document.querySelector(s), uid=()=>Math.random().toString(36).slice(2,9);
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
const DEVKEY="razem-device-id"; let deviceId=localStorage.getItem(DEVKEY); if(!deviceId){deviceId="u_"+uid();localStorage.setItem(DEVKEY,deviceId);}

/* ====== PAMIĘĆ LOKALNA STRONY ====== */
const HUB_KEY="razem-hub-v8";
let hub={docs:{}, lastOpenId:null, lastOpenBranch:null};

function load(){
  const raw=localStorage.getItem(HUB_KEY);
  if(raw){try{const parsed=JSON.parse(raw); if(parsed && typeof parsed==='object') hub=Object.assign(hub, parsed);}catch{}}
}
function saveLocal({sync=true, docId=null}={}){
  localStorage.setItem(HUB_KEY, JSON.stringify(hub));
  const targetId=docId || (sync? curId:null);
  if(sync && targetId && hub.docs[targetId]){
    remotePut(hub.docs[targetId]).catch(err=>console.error('remotePut failed', err));
  }
}
function saveLocalAndRender(options){
  saveLocal(options);
  if($("#home").style.display==="block") renderHome();
}

/* ====== API ====== */
async function apiMe(){ try{ const r=await fetch('/api/me'); if(!r.ok) return null; return await r.json(); }catch{ return null; } }
async function setUsername(name){
  const r = await fetch('/api/setup',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({username:name})});
  if(!r.ok) throw new Error(await r.text()); return await r.json();
}
async function remoteList(){
  try{
    const r=await fetch('/api/docs');
    if(!r.ok){ console.error('remoteList failed', r.status); return null; }
    const data=await r.json();
    return Array.isArray(data?.ids)? data.ids : [];
  }catch(err){ console.error('remoteList error', err); return null; }
}
async function remoteGet(id){
  try{
    const r=await fetch('/api/docs?id='+encodeURIComponent(id));
    if(!r.ok){ console.warn('remoteGet failed', id, r.status); return null; }
    const data=await r.json();
    if(!data || !data.id) return null;
    data.owner=data.owner||data.ownerUserId||data.ownerId||null;
    data.ownerName=data.ownerName||data.ownerUsername||'';
    data.branches=data.branches||{};
    Object.values(data.branches).forEach(b=>{
      b.comments=Array.isArray(b.comments)?b.comments:[];
      b.reactions=b.reactions||{plus:[],wiki:[]};
      if(!Array.isArray(b.reactions.plus)) b.reactions.plus=[];
      if(!Array.isArray(b.reactions.wiki)) b.reactions.wiki=[];
      b.owner=b.owner||data.owner;
      b.ownerName=b.ownerName||data.ownerName||'';
    });
    data.comments=data.comments||{};
    data.anchors=data.anchors||{};
    return data;
  }catch(err){ console.error('remoteGet error', err); return null; }
}
async function remotePut(doc){
  try{
    const r=await fetch('/api/docs',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({id:doc.id,doc})});
    if(!r.ok){ const txt=await r.text(); console.error('remotePut failed', r.status, txt); }
  }catch(err){ console.error('remotePut error', err); }
}
async function remoteDelete(id){
  try{
    const r=await fetch('/api/docs?id='+encodeURIComponent(id),{method:'DELETE'});
    if(!r.ok){ const txt=await r.text(); throw new Error(txt||('HTTP '+r.status)); }
    return true;
  }catch(err){ console.error('remoteDelete error', err); alert('Nie udało się usunąć (brak uprawnień?).'); return false; }
}

/* ====== USER ====== */
let me=null;
async function ensureUsername(){
  me = await apiMe();
  const badge = document.getElementById('user-badge');
  const badge2 = document.getElementById('user-badge-doc');
  const fallback = me?.username || me?.email?.split('@')[0] || me?.userId || '';
  const label = fallback ? '@'+fallback : '';
  badge.textContent=label;
  badge2.textContent=label;
  if(me && me.username){ return true; }
  if(!me || !me.ok){ return false; } // brak Access
  const overlay = document.getElementById('username-overlay');
  const input = document.getElementById('username-input');
  const saveBtn = document.getElementById('username-save');
  const err = document.getElementById('username-err');
  overlay.style.display='flex'; input.value=''; input.focus();
  return await new Promise(resolve=>{
    async function trySave(){
      err.textContent='';
      const name=input.value.trim().toLowerCase();
      if(!/^[a-z0-9_]{3,20}$/.test(name)){ err.textContent='Niepoprawny format username.'; return; }
      try{
        await setUsername(name);
        me.username=name;
        const display='@'+name;
        document.getElementById('user-badge').textContent=display;
        document.getElementById('user-badge-doc').textContent=display;
        overlay.style.display='none';
        resolve(true);
      }catch(e){
        const msg=(''+e.message);
        if(msg.includes('taken')) err.textContent='Ta nazwa jest zajęta. Spróbuj inną.';
        else err.textContent='Błąd zapisu. Spróbuj ponownie.';
      }
    }
    saveBtn.onclick=trySave;
    input.addEventListener('keydown',e=>{ if(e.key==='Enter') trySave(); });
  });
}
function currentUserLabel(){ return me?.username || me?.email?.split('@')[0] || 'anon'; }

/* ====== HOME ====== */
function renderHome(){
  $("#home").style.display="block"; $("#doc").style.display="none";
  $("#global-actions").style.display="flex"; $("#doc-actions").style.display="none";

  const list=$("#doc-list"); list.innerHTML="";
  const docs=Object.values(hub.docs).sort((a,b)=>a.updated<b.updated?1:-1);
  $("#empty-home").style.display=docs.length?"none":"block";
  docs.forEach(d=>{
    const el=document.createElement("div"); el.className="card";
    const desc = d.desc?.trim() ? esc(d.desc.trim()) : "<i class='muted'>(brak opisu)</i>";
    const author = d.ownerName ? ` • <span class="muted">@${esc(d.ownerName)}</span>` : "";
    const canDelete = me && me.userId && d.owner===me.userId;
    el.innerHTML=`<div style="display:flex;gap:8px;align-items:center">
        <strong>${esc(d.title||'Nowy dokument')}</strong>
        <span class="muted" style="margin-left:auto">${new Date(d.updated).toLocaleString()}</span>
      </div>
      <div class="muted" style="margin-top:6px">${desc}${author}</div>
      <div class="row" style="margin-top:8px">
        <button class="tbtn" data-open="${d.id}">Otwórz</button>
        <button class="tbtn" data-export="${d.id}">Export</button>
        ${canDelete ? `<button class="tbtn" data-del="${d.id}" style="color:#8a0d28;border-color:#e5b3be">Usuń</button>` : ``}
      </div>`;
    list.appendChild(el);
  });
  list.querySelectorAll("[data-open]").forEach(b=>b.onclick=()=>openDoc(b.dataset.open));
  list.querySelectorAll("[data-export]").forEach(b=>b.onclick=()=>exportDoc(b.dataset.export));
  list.querySelectorAll("[data-del]").forEach(b=>b.onclick=async()=>{ if(confirm("Na pewno usunąć ten dokument?")){ await deleteDoc(b.dataset.del); }});
} // <— important: close renderHome()

// brand click => Home
$("#brand-home").onclick=()=>showHome(true);
function showHome(force=false){
  curId=null; curBranchId=null;
  hub.lastOpenBranch=null;
  saveLocal({sync:false});
  renderHome();
}

/* ====== DOC ====== */
let curId=null, curBranchId=null;
function setMetaMode(published){ $("#meta-edit").style.display= published? "none":"grid"; $("#meta-view").style.display= published? "block":"none"; }
function openDoc(id){
  curId=id; curBranchId=null; hub.lastOpenId=id; saveLocal({sync:false});
  $("#home").style.display="none"; $("#doc").style.display="block";
  $("#global-actions").style.display="none"; $("#doc-actions").style.display="flex";
  const d=hub.docs[id];
  $("#page").innerHTML=d.html||"<p><b>Wklej tutaj transkrypt.</b></p>";
  setMetaMode(d.metaPublished);
  $("#meta-title").value=d.title||""; $("#meta-yt").value=d.yt||""; $("#meta-desc").value=d.desc||"";
  $("#v-title").textContent=d.title||""; $("#v-yt").textContent=d.yt||"—"; $("#v-yt").href=d.yt||"#"; $("#v-desc").textContent=d.desc||"";

  const delBtn=$("#doc-delete");
  if(me && d.owner===me.userId) delBtn.style.display='inline-flex'; else delBtn.style.display='none';
  setTimeout(()=>attachInline(),0);
}
$("#back-home").onclick=()=>showHome(true);

$("#meta-publish").onclick=()=>{
  const d=hub.docs[curId]; snapshot();
  d.title=$("#meta-title").value.trim()||"Bez tytułu";
  d.yt=$("#meta-yt").value.trim();
  d.desc=$("#meta-desc").value.trim();
  d.metaPublished=true; d.updated=new Date().toISOString(); saveLocal({docId:curId});
  $("#v-title").textContent=d.title; $("#v-yt").textContent=d.yt||"—"; $("#v-yt").href=d.yt||"#"; $("#v-desc").textContent=d.desc||"";
  setMetaMode(true);
};
$("#meta-edit-btn").onclick=()=>{const d=hub.docs[curId]; setMetaMode(false); $("#meta-title").value=d.title; $("#meta-yt").value=d.yt; $("#meta-desc").value=d.desc;};
["meta-title","meta-yt","meta-desc"].forEach(id=>{ $("#"+id).addEventListener("input",()=>{const d=hub.docs[curId]; if(!d)return; snapshot(); d.title=$("#meta-title").value; d.yt=$("#meta-yt").value; d.desc=$("#meta-desc").value; d.updated=new Date().toISOString(); saveLocal({docId:curId});});});

$("#page").addEventListener("input",()=>{const d=hub.docs[curId]; d.html=$("#page").innerHTML; d.updated=new Date().toISOString(); saveLocal({docId:curId});});
$("#page").addEventListener("keydown",()=>{snapshot();},{capture:true});
$("#page").addEventListener("beforeinput",(e)=>{const sel=window.getSelection(); if(!sel.rangeCount) return; const node=(sel.anchorNode?.nodeType===1? sel.anchorNode: sel.anchorNode?.parentElement); if(e.inputType.startsWith("delete") || e.inputType==="insertText"){ if(node && (node.closest(".inline-tag") || node.closest("[contenteditable='false']"))) e.preventDefault(); }});
document.querySelectorAll(".tbtn[data-cmd]").forEach(b=>b.onclick=()=>{snapshot(); document.execCommand(b.dataset.cmd,false,null); const d=hub.docs[curId]; d.html=$("#page").innerHTML; saveLocal({docId:curId});});
function fontDelta(n){const sel=window.getSelection(); if(!sel.rangeCount||sel.isCollapsed) return; snapshot(); const r=sel.getRangeAt(0); const s=document.createElement("span"); s.style.fontSize=`calc(1em + ${n>0?'.1':'-.1'}em)`; s.appendChild(r.extractContents()); r.insertNode(s); const d=hub.docs[curId]; d.html=$("#page").innerHTML; saveLocal({docId:curId});}
$("#font-inc").onclick=()=>fontDelta(1); $("#font-dec").onclick=()=>fontDelta(-1);
$("#clear-format").onclick=()=>{snapshot(); document.execCommand("removeFormat",false,null); const d=hub.docs[curId]; d.html=$("#page").innerHTML; saveLocal({docId:curId});};

/* ====== BRANCHES ====== */
function addBranchFromSelection(){
  const sel=window.getSelection(); if(!sel.rangeCount||sel.isCollapsed){alert("Zaznacz tekst."); return;}
  snapshot(); const r=sel.getRangeAt(0); const anchorId="a_"+uid();
  const wrap=document.createElement("span"); wrap.className="branch-anchor"; wrap.id=anchorId; wrap.appendChild(r.cloneContents());
  r.deleteContents(); r.insertNode(wrap); sel.removeAllRanges();
  const bid="b_"+uid(); spawnInlineTag(anchorId);
  const q=wrap.textContent.trim().slice(0,180); const d=hub.docs[curId];
  if(!d.anchors[anchorId]) d.anchors[anchorId]=[];
  d.anchors[anchorId].push(bid);
  d.branches[bid]={id:bid,anchorId,quoteText:q,title:"",body:"",comments:[],reactions:{plus:[],wiki:[]},owner:me?.userId||deviceId,ownerName:currentUserLabel(),posted:false,created:new Date().toISOString(),updated:new Date().toISOString()};
  d.html=$("#page").innerHTML; d.updated=new Date().toISOString(); saveLocal({docId:curId}); openBranch(bid,true);
}
$("#add-branch").onclick=addBranchFromSelection;

function spawnInlineTag(anchorId){
  const anchor=document.getElementById(anchorId); if(!anchor) return;
  const next=anchor.nextElementSibling; if(next && next.classList.contains("inline-tag")) next.remove();
  const d=hub.docs[curId]; const count=(d.anchors[anchorId]||[]).length;
  const tag=document.createElement("span"); tag.className="inline-tag"; tag.textContent=count?`branch ×${count}`:"branch"; tag.dataset.anchor=anchorId; tag.setAttribute("contenteditable","false"); anchor.after(tag);
}
function attachInline(){ const d=hub.docs[curId]; Object.keys(d.anchors).forEach(aid=>{ if(document.getElementById(aid)) spawnInlineTag(aid); }); }
const pop=$("#anchor-pop");

// click handling
document.addEventListener('click',(e)=>{
  const tag=e.target.closest('.inline-tag');
  if(tag){
    e.preventDefault();
    openAnchorMenu(tag);
    return;
  }
  const anchor=e.target.closest('.branch-anchor');
  if(anchor){
    e.preventDefault();
    const next=anchor.nextElementSibling;
    if(next && next.classList.contains('inline-tag')){
      openAnchorMenu(next);
    } else {
      spawnInlineTag(anchor.id);
      const t2=anchor.nextElementSibling;
      if(t2 && t2.classList.contains('inline-tag')) openAnchorMenu(t2);
    }
    return;
  }
  if(pop.style.display==='block' && !pop.contains(e.target)) pop.style.display='none';
});

// popover with branch list
function openAnchorMenu(el){
  const aid = el.dataset.anchor;
  const d = hub.docs[curId];
  const arr = (d.anchors[aid] || []).slice();

  // content
  pop.innerHTML = "";
  const add = document.createElement("div");
  add.className = "pop-item";
  add.textContent = "Dodaj nowy branch";
  add.onclick = () => {
    pop.style.display = "none";
    const anchor = document.getElementById(aid);
    if(!anchor) return;
    const range = document.createRange();
    range.selectNodeContents(anchor);
    const sel = window.getSelection();
    sel.removeAllRanges();
    sel.addRange(range);
    addBranchFromSelection();
  };
  pop.appendChild(add);

  arr.forEach(bid => {
    const b = d.branches[bid];
    if(!b) return;
    const it = document.createElement("div");
    it.className = "pop-item";
    it.textContent = (b.title || b.quoteText || "branch").slice(0, 100);
    it.onclick = () => { pop.style.display="none"; openBranch(bid); };
    pop.appendChild(it);
  });

  // position
  const r = el.getBoundingClientRect();
  pop.style.left = (r.left + window.scrollX) + "px";
  pop.style.top  = (r.bottom + window.scrollY + 6) + "px";
  pop.style.display = "block";
}

function branch(){return hub.docs[curId].branches[curBranchId]}
function openBranch(bid,newly=false){
  curBranchId=bid; hub.lastOpenBranch=bid; saveLocal({sync:false});
  const b=hub.docs[curId].branches[bid];
  const isMine = !!me && b.owner===me.userId;

  if(b.posted){
    $("#b-editable").style.display="none";
    $("#b-locked").style.display="block";
    $("#post-section").style.display="block";
    $("#drawer-title").textContent=b.title||"Branch";
    $("#b-view-title").textContent=b.title||"(bez tytułu)";
    $("#b-view-body").textContent=b.body||"";
    $("#b-meta").textContent = `@${b.ownerName} • ${new Date(b.created).toLocaleString()}`;
  }else{
    $("#b-editable").style.display="block";
    $("#b-locked").style.display="none";
    $("#post-section").style.display="none";
    $("#drawer-title").textContent="Branch";
    $("#b-title").value=b.title||"";
    $("#b-body").value=b.body||"";
    $("#b-status").textContent="Roboczy — opublikuj, aby odblokować odpowiedzi i reakcje.";
  }
  $("#b-edit").style.display = isMine? 'inline-flex' : 'none';
  $("#b-delete").style.display = isMine? 'inline-flex' : 'none';

  renderReactions(b); renderComments(b);
  $("#drawer").style.display="block"; if(newly && !b.posted) $("#b-title").focus();
}
// draggable drawer
(function(){
  const drag=$("#drawer-head"); const panel=$("#drawer"); let sx=0, sy=0, ox=0, oy=0, dragging=false;
  drag.addEventListener('mousedown',e=>{dragging=true; sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; document.body.style.userSelect='none';});
  window.addEventListener('mousemove',e=>{if(!dragging) return; const dx=e.clientX-sx, dy=e.clientY-sy; panel.style.left=(ox+dx)+'px'; panel.style.top=(oy+dy)+'px'; panel.style.right='auto'; panel.style.bottom='auto'; panel.style.position='fixed';});
  window.addEventListener('mouseup',()=>{dragging=false; document.body.style.userSelect='';});
})();
function closeDrawer(){ $("#drawer").style.display="none"; } $("#drawer-close").onclick=closeDrawer;

$("#b-post").onclick=()=>{const b=branch(); if(!b) return; const t=$("#b-title").value.trim(), body=$("#b-body").value.trim(); if(!t||!body){alert("Podaj tytuł i treść."); return;} snapshot(); b.title=t; b.body=body; b.posted=true; b.owner=me?.userId||deviceId; b.ownerName=currentUserLabel(); b.updated=new Date().toISOString(); b.created=b.created||new Date().toISOString(); saveLocal({docId:curId}); openBranch(b.id);};
$("#b-edit").onclick=()=>{const b=branch(); if(!b) return; if(!(me && b.owner===me.userId)){alert("Tylko autor może edytować wpis."); return;} $("#b-editable").style.display="block"; $("#b-locked").style.display="none"; $("#post-section").style.display="none"; $("#b-title").value=b.title||""; $("#b-body").value=b.body||""; $("#b-title").focus();};
$("#b-delete").onclick=()=>{const d=hub.docs[curId]; const b=d.branches[curBranchId]; if(!b)return; if(!(me && b.owner===me.userId)){alert("Tylko autor może usunąć."); return;} if(!confirm("Usunąć brancha?")) return; snapshot(); const tag=document.querySelector(`.inline-tag[data-anchor='${b.anchorId}']`); const anchor=document.getElementById(b.anchorId); d.anchors[b.anchorId]=(d.anchors[b.anchorId]||[]).filter(x=>x!==b.id); if(d.anchors[b.anchorId].length===0){ if(anchor){const p=anchor.parentNode; while(anchor.firstChild) p.insertBefore(anchor.firstChild,anchor); anchor.remove(); } if(tag) tag.remove(); delete d.anchors[b.anchorId]; } else { if(tag) tag.textContent=`branch ×${d.anchors[b.anchorId].length}`; } delete d.branches[b.id]; d.html=$("#page").innerHTML; d.updated=new Date().toISOString(); saveLocal({docId:curId}); closeDrawer();};

function renderReactions(b){const bar=$("#react-bar"); bar.innerHTML=""; const plusActive=(b.reactions?.plus||[]).includes(me?.userId); const wikiActive=(b.reactions?.wiki||[]).includes(me?.userId); const plus=document.createElement("button"); plus.className="chip"+(plusActive?" active":""); plus.innerHTML=`+1 <span class="badge">${(b.reactions.plus||[]).length}</span>`; plus.onclick=()=>{snapshot(); toggleOne(b,"plus");}; const wiki=document.createElement("button"); wiki.className="chip"+(wikiActive?" active":""); wiki.innerHTML=`Wiki <span class="badge">${(b.reactions.wiki||[]).length}</span>`; wiki.onclick=()=>{snapshot(); toggleOne(b,"wiki");}; bar.appendChild(plus); bar.appendChild(wiki);}
function toggleOne(b,key){ if(!b.posted) return; b.reactions=b.reactions||{plus:[],wiki:[]}; if(!Array.isArray(b.reactions[key])) b.reactions[key]=[]; const arr=b.reactions[key]; const myId = me?.userId; if(!myId) return; const i=arr.indexOf(myId); if(i>-1) arr.splice(i,1); else arr.push(myId); b.updated=new Date().toISOString(); saveLocal({docId:curId}); renderReactions(b);}
$("#reply-btn").onclick=addReply; $("#reply-text").addEventListener("keydown",e=>{if(e.key==="Enter"){e.preventDefault(); addReply();}});
function addReply(){const b=branch(); if(!b||!b.posted) return; const t=$("#reply-text").value.trim(); if(!t) return; snapshot(); b.comments.push({id:"c_"+uid(),userId:me?.userId,text:t,username:currentUserLabel(),ts:new Date().toISOString()}); $("#reply-text").value=""; b.updated=new Date().toISOString(); saveLocal({docId:curId}); renderComments(b);}
function deleteComment(cid){const b=branch(); if(!b) return; snapshot(); b.comments=b.comments.filter(c=>!(c.id===cid && c.userId===me?.userId)); b.updated=new Date().toISOString(); saveLocal({docId:curId}); renderComments(b);}
function renderComments(b){const box=$("#comments"); box.innerHTML=""; if(!b.comments.length){ box.innerHTML=`<div class="muted"><i>Brak odpowiedzi.</i></div>`; return } b.comments.forEach(c=>{const el=document.createElement("div"); el.className="comment"; const meta = `@${esc(c.username||'anon')} • ${new Date(c.ts).toLocaleString()}`; el.innerHTML=`<div style="min-width:0"><div style="word-wrap:break-word; white-space:pre-wrap">${esc(c.text)}</div><div class="meta">${meta}</div></div>${c.userId===me?.userId?'<button class="del" data-cid="'+c.id+'">Usuń</button>':''}`; box.appendChild(el);}); box.querySelectorAll("[data-cid]").forEach(b=>b.onclick=()=>deleteComment(b.dataset.cid));}

/* ====== OVERVIEW ====== */
$("#open-overview").onclick=()=>openOverview("top");
$("#overview-close").onclick=()=>$("#overview").style.display="none";
document.querySelectorAll("#overview .pill").forEach(p=>p.onclick=()=>openOverview(p.dataset.sort));
function openOverview(mode){const d=hub.docs[curId]; const list=$("#overview-list"); const modal=$("#overview"); let arr=Object.values(d.branches||{}).filter(b=>b.posted); const score=b=> (b.reactions.plus?.length||0)+(b.reactions.wiki?.length||0); if(mode==="top") arr.sort((a,b)=>score(b)-score(a)); else if(mode==="comments") arr.sort((a,b)=>b.comments.length-a.comments.length); else arr.sort((a,b)=>new Date(b.created)-new Date(a.created)); list.innerHTML=""; if(!arr.length){ list.innerHTML=`<p class="muted"><i>Brak opublikowanych branchy.</i></p>`; } arr.forEach(b=>{const el=document.createElement("div"); el.className="panel"; el.style.marginTop="8px"; const meta = `@${esc(b.ownerName||'anon')} • ${new Date(b.created).toLocaleString()}`; el.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><strong>${esc(b.title||"(bez tytułu)")}</strong><span class="muted" style="margin-left:auto">${new Date(b.created).toLocaleString()}</span></div><div class="muted" style="margin-top:4px">„${esc(b.quoteText||"")}”</div><div class="muted" style="margin-top:4px;font-size:12px">${meta}</div><div class="row" style="margin-top:6px"><button class="tbtn" data-open="${b.id}">Otwórz</button><button class="tbtn" data-jump="${b.anchorId}">Pokaż w tekście</button><span class="muted" style="margin-left:auto">💬 ${b.comments.length} • ✨ ${score(b)}</span></div>`; list.appendChild(el);}); list.querySelectorAll("[data-open]").forEach(btn=>btn.onclick=()=>{modal.style.display="none"; openBranch(btn.dataset.open);}); list.querySelectorAll("[data-jump]").forEach(btn=>btn.onclick=()=>{modal.style.display="none"; scrollAndHighlight(btn.dataset.jump);}); modal.style.display="flex";}
function scrollAndHighlight(anchorId){const el=document.getElementById(anchorId); if(!el){alert("Nie znaleziono fragmentu."); return;} el.scrollIntoView({block:"center",behavior:"smooth"}); el.classList.add("flash"); setTimeout(()=>el.classList.remove("flash"),2400);}

/* ====== SNAPSHOT (undo/redo) ====== */
const historyStack=[], redoStack=[];
function snapshot(){ if(!curId) return; const d=structClone(hub.docs[curId]); historyStack.push(d); if(historyStack.length>60) historyStack.shift(); redoStack.length=0;}
function structClone(o){ return (typeof structuredClone==='function')? structuredClone(o) : JSON.parse(JSON.stringify(o));}
document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){ e.preventDefault(); e.shiftKey? redo(): undo(); }});
function undo(){ const prev=historyStack.pop(); if(!prev) return; redoStack.push(structClone(hub.docs[curId])); hub.docs[curId]=prev; saveLocal({docId:curId}); openDoc(curId);}
function redo(){ const next=redoStack.pop(); if(!next) return; historyStack.push(structClone(hub.docs[curId])); hub.docs[curId]=next; saveLocal({docId:curId}); openDoc(curId);}

/* ====== EXPORT/IMPORT/DOC CRUD ====== */
function exportDoc(id){const data=hub.docs[id]; const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"}); const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=(data.title||"razem-debate")+".json"; a.click();}
$("#doc-export").onclick=()=>exportDoc(curId);
$("#home-new").onclick=()=>{const id=createDoc({title:"Nowy dokument",html:"<p><b>Wklej tutaj transkrypt.</b></p>"}); openDoc(id);};
$("#home-docx").addEventListener("change",async(e)=>{const file=e.target.files?.[0]; if(!file)return; try{const ab=await file.arrayBuffer(); const res=await window.mammoth.convertToHtml({arrayBuffer:ab}); const title=file.name.replace(/\.docx$/i,""); const id=createDoc({title,html:res.value}); openDoc(id);}catch(err){alert("Import .docx nie powiódł się — sprawdź konsolę."); console.error(err);}});

function createDoc({title="Nowy dokument",html=""}={}){const id="d_"+uid(); hub.docs[id]={id,title,desc:"",yt:"",metaPublished:false,html,branches:{},anchors:{},comments:{},owner:me?.userId||deviceId,ownerName:currentUserLabel(),created:new Date().toISOString(),updated:new Date().toISOString()}; saveLocalAndRender({docId:id}); return id}
async function deleteDoc(id){
  const ok = await remoteDelete(id);
  if(!ok) return false;
  delete hub.docs[id];
  if(hub.lastOpenId===id) hub.lastOpenId=null;
  if(hub.lastOpenBranch && (!hub.lastOpenId || !hub.docs[hub.lastOpenId]?.branches[hub.lastOpenBranch])) hub.lastOpenBranch=null;
  saveLocalAndRender({sync:false});
  return true;
}
$("#doc-delete").onclick=()=>{const d=hub.docs[curId]; if(!(me && d.owner===me.userId)) { alert("Tylko autor może usunąć dokument."); return; } if(confirm("Na pewno usunąć ten dokument?")){ deleteDoc(curId).then(success=>{ if(success) showHome(true); }); }}

/* ====== START ====== */
window.addEventListener("load", async ()=>{
  load();
  await ensureUsername(); // pokaże overlay jeśli trzeba

  const ids = await remoteList();
  if (Array.isArray(ids)) {
    const known = new Set(ids);
    for (const id of ids) {
      const remote = await remoteGet(id);
      if (remote && remote.id) {
        const local = hub.docs[id] || {};
        hub.docs[id] = Object.assign({}, local, remote);
        delete hub.docs[id].ownerUserId;
        delete hub.docs[id].ownerUsername;
      }
    }
    Object.keys(hub.docs).forEach(id=>{ if(!known.has(id)) delete hub.docs[id]; });
    saveLocal({sync:false});
  }

  const docIds=Object.keys(hub.docs);
  if(docIds.length===0){ renderHome(); return; }
  if(hub.lastOpenId && hub.docs[hub.lastOpenId]) {
    openDoc(hub.lastOpenId);
    if(hub.lastOpenBranch && hub.docs[hub.lastOpenId].branches[hub.lastOpenBranch]) openBranch(hub.lastOpenBranch);
  } else {
    renderHome();
  }
});
</script>
</body>
</html>
